use crate::artifacts::os::windows::shellitems::items::get_shellitem;
use deno_core::{anyhow::anyhow, error::AnyError, op2, JsBuffer, ToJsBuffer};
use serde::Serialize;

#[derive(Serialize)]
pub(crate) struct JsShellitem {
    item: String,
    remaining: ToJsBuffer,
}

#[op2]
#[serde]
/// Parse raw shellitem bytes and return remaining bytes
pub(crate) fn js_get_shellitem(#[buffer] data: JsBuffer) -> Result<JsShellitem, AnyError> {
    let results = get_shellitem(&data);
    let (remaining, item_data) = match results {
        Ok(result) => result,
        Err(_) => return Err(anyhow!("Failed to get shellitem")),
    };

    let item = serde_json::to_string(&item_data)?;
    let value = JsShellitem {
        item,
        remaining: remaining.to_vec().into(),
    };
    Ok(value)
}

#[cfg(test)]
mod tests {
    use crate::{
        runtime::deno::execute_script, structs::artifacts::runtime::script::JSScript,
        structs::toml::Output,
    };

    fn output_options(name: &str, output: &str, directory: &str, compress: bool) -> Output {
        Output {
            name: name.to_string(),
            directory: directory.to_string(),
            format: String::from("json"),
            compress,
            url: Some(String::new()),
            api_key: Some(String::new()),
            endpoint_id: String::from("abcd"),
            collection_id: 0,
            output: output.to_string(),
            filter_name: None,
            filter_script: None,
            logging: None,
        }
    }

    #[test]
    fn test_js_get_shellitem() {
        let test = "Ly8gaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3B1ZmZ5Y2lkL2FydGVtaXMtYXBpL21hc3Rlci9zcmMvZmlsZXN5c3RlbS9maWxlcy50cwpmdW5jdGlvbiBnbG9iKHBhdHRlcm4pIHsKICBjb25zdCByZXN1bHQgPSBmcy5nbG9iKHBhdHRlcm4pOwogIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBFcnJvcikgewogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UocmVzdWx0KTsKICByZXR1cm4gZGF0YTsKfQoKLy8gLi4vLi4vUHJvamVjdHMvYXJ0ZW1pcy1hcGkvc3JjL3V0aWxzL2Vycm9yLnRzCnZhciBFcnJvckJhc2UgPSBjbGFzcyBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihuYW1lLCBtZXNzYWdlKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgfQp9OwoKLy8gLi4vLi4vUHJvamVjdHMvYXJ0ZW1pcy1hcGkvc3JjL3dpbmRvd3MvZXJyb3JzLnRzCnZhciBXaW5kb3dzRXJyb3IgPSBjbGFzcyBleHRlbmRzIEVycm9yQmFzZSB7Cn07CgovLyAuLi8uLi9Qcm9qZWN0cy9hcnRlbWlzLWFwaS9zcmMvd2luZG93cy9yZWdpc3RyeS50cwpmdW5jdGlvbiBnZXRSZWdpc3RyeShwYXRoKSB7CiAgdHJ5IHsKICAgIGNvbnN0IGRhdGEgPSBEZW5vLmNvcmUub3BzLmdldF9yZWdpc3RyeShwYXRoKTsKICAgIGNvbnN0IHJlc3VsdHMgPSBKU09OLnBhcnNlKGRhdGEpOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfSBjYXRjaCAoZXJyKSB7CiAgICByZXR1cm4gbmV3IFdpbmRvd3NFcnJvcigKICAgICAgIlJFR0lTVFJZIiwKICAgICAgYGZhaWxlZCB0byBwYXJzZSByZWdpc3RyeSBmaWxlICR7cGF0aH06ICR7ZXJyfWAKICAgICk7CiAgfQp9CgovLyAuLi8uLi9Qcm9qZWN0cy9hcnRlbWlzLWFwaS9zcmMvZW5jb2RpbmcvZXJyb3JzLnRzCnZhciBFbmNvZGluZ0Vycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvckJhc2Ugewp9OwoKLy8gLi4vLi4vUHJvamVjdHMvYXJ0ZW1pcy1hcGkvc3JjL2VuY29kaW5nL2Jhc2U2NC50cwpmdW5jdGlvbiBkZWNvZGUoYjY0KSB7CiAgdHJ5IHsKICAgIGNvbnN0IGJ5dGVzID0gZW5jb2RpbmcuYXRvYihiNjQpOwogICAgcmV0dXJuIGJ5dGVzOwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIG5ldyBFbmNvZGluZ0Vycm9yKCJCQVNFNjQiLCBgZmFpbGVkIHRvIGRlY29kZSAke2I2NH06ICR7ZXJyfWApOwogIH0KfQoKLy8gLi4vLi4vUHJvamVjdHMvYXJ0ZW1pcy1hcGkvc3JjL2VuY29kaW5nL3N0cmluZ3MudHMKZnVuY3Rpb24gZXh0cmFjdFV0ZjE2U3RyaW5nKGRhdGEpIHsKICBjb25zdCByZXN1bHQgPSBlbmNvZGluZy5leHRyYWN0X3V0ZjE2X3N0cmluZyhkYXRhKTsKICByZXR1cm4gcmVzdWx0Owp9CgovLyAuLi8uLi9Qcm9qZWN0cy9hcnRlbWlzLWFwaS9zcmMvbm9tL2Vycm9yLnRzCnZhciBOb21FcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3JCYXNlIHsKfTsKCi8vIC4uLy4uL1Byb2plY3RzL2FydGVtaXMtYXBpL3NyYy9ub20vcGFyc2Vycy50cwpmdW5jdGlvbiB0YWtlKGRhdGEsIGlucHV0KSB7CiAgaWYgKGlucHV0IDwgMCkgewogICAgcmV0dXJuIG5ldyBOb21FcnJvcigiTk9NIiwgInByb3ZpZGVkIG5lZ2F0aXZlIG51bWJlciIpOwogIH0KICBpZiAodHlwZW9mIGRhdGEgPT09ICJzdHJpbmciKSB7CiAgICB0cnkgewogICAgICBjb25zdCByZXN1bHRfc3RyaW5nID0gRGVuby5jb3JlLm9wcy5qc19ub21fdGFrZV9zdHJpbmcoCiAgICAgICAgZGF0YSwKICAgICAgICBpbnB1dAogICAgICApOwogICAgICBjb25zdCBub21fc3RyaW5nID0gSlNPTi5wYXJzZShyZXN1bHRfc3RyaW5nKTsKICAgICAgcmV0dXJuIG5vbV9zdHJpbmc7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgcmV0dXJuIG5ldyBOb21FcnJvcigiTk9NIiwgYGNvdWxkIG5vdCB0YWtlIHN0cmluZyAke2Vycn1gKTsKICAgIH0KICB9CiAgdHJ5IHsKICAgIGNvbnN0IHJlc3VsdCA9IERlbm8uY29yZS5vcHMuanNfbm9tX3Rha2VfYnl0ZXMoZGF0YSwgaW5wdXQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBuZXcgTm9tRXJyb3IoIk5PTSIsIGBjb3VsZCBub3QgdGFrZSBieXRlcyAke2Vycn1gKTsKICB9Cn0KZnVuY3Rpb24gdGFrZVVudGlsKGRhdGEsIGlucHV0KSB7CiAgaWYgKHR5cGVvZiBkYXRhICE9IHR5cGVvZiBpbnB1dCkgewogICAgcmV0dXJuIG5ldyBOb21FcnJvcigiTk9NIiwgImRhdGEgYW5kIGlucHV0IG11c3QgYmUgbWF0Y2hpbmcgdHlwZXMiKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiAmJiB0eXBlb2YgaW5wdXQgPT09ICJzdHJpbmciKSB7CiAgICB0cnkgewogICAgICBjb25zdCByZXN1bHRfc3RyaW5nID0gRGVuby5jb3JlLm9wcy5qc19ub21fdGFrZV91bnRpbF9zdHJpbmcoCiAgICAgICAgZGF0YSwKICAgICAgICBpbnB1dAogICAgICApOwogICAgICBjb25zdCBub21fc3RyaW5nID0gSlNPTi5wYXJzZShyZXN1bHRfc3RyaW5nKTsKICAgICAgcmV0dXJuIG5vbV9zdHJpbmc7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgcmV0dXJuIG5ldyBOb21FcnJvcigiTk9NIiwgYGNvdWxkIG5vdCB0YWtlIHVudGlsIHN0cmluZyAke2Vycn1gKTsKICAgIH0KICB9CiAgdHJ5IHsKICAgIGNvbnN0IHJlc3VsdCA9IERlbm8uY29yZS5vcHMuanNfbm9tX3Rha2VfdW50aWxfYnl0ZXMoCiAgICAgIGRhdGEsCiAgICAgIGlucHV0CiAgICApOwogICAgcmV0dXJuIHJlc3VsdDsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBuZXcgTm9tRXJyb3IoIk5PTSIsIGBjb3VsZCBub3QgdGFrZSB1bnRpbCBieXRlcyAke2Vycn1gKTsKICB9Cn0KCi8vIC4uLy4uL1Byb2plY3RzL2FydGVtaXMtYXBpL3NyYy93aW5kb3dzL3NoZWxsaXRlbXMudHMKZnVuY3Rpb24gZ2V0U2hlbGxJdGVtKGRhdGEpIHsKICB0cnkgewogICAgY29uc3QgcmVzdWx0ID0gRGVuby5jb3JlLm9wcy5qc19nZXRfc2hlbGxpdGVtKGRhdGEpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBuZXcgV2luZG93c0Vycm9yKCJTSEVMTElURU1TIiwgYGZhaWxlZCB0byBnZXQgc2hlbGxpdGVtczogJHtlcnJ9YCk7CiAgfQp9CgovLyAuLi8uLi9Qcm9qZWN0cy9hcnRlbWlzLWFwaS9zcmMvd2luZG93cy9yZWdpc3RyeS9tcnUvY29tbW9uLnRzCmZ1bmN0aW9uIG9wZW5TYXZlTXJ1KHJlZ19kYXRhKSB7CiAgY29uc3QgbXJ1X2VudHJpZXMgPSBbXTsKICBmb3IgKGNvbnN0IGVudHJ5IG9mIHJlZ19kYXRhKSB7CiAgICBpZiAoIWVudHJ5LnBhdGguaW5jbHVkZXMoCiAgICAgICJTb2Z0d2FyZVxcTWljcm9zb2Z0XFxXaW5kb3dzXFxDdXJyZW50VmVyc2lvblxcRXhwbG9yZXJcXENvbURsZzMyXFxPcGVuU2F2ZVBpZGxNUlUiCiAgICApKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgbXJ1X2VudHJpZXMucHVzaChlbnRyeSk7CiAgfQogIGNvbnN0IG1ydXMgPSBbXTsKICBmb3IgKGNvbnN0IGVudHJpZXMgb2YgbXJ1X2VudHJpZXMpIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgZW50cmllcy52YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlLnZhbHVlID09PSAiTVJVTGlzdEV4IikgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxldCBkYXRhID0gZGVjb2RlKHZhbHVlLmRhdGEpOwogICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEVuY29kaW5nRXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBjb3VsZCBub3QgZGVjb2RlIE9wZW5TYXZlIGtleSAke3ZhbHVlLnZhbHVlfTogJHtkYXRhfWApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGl0ZW1zID0gW107CiAgICAgIHdoaWxlIChkYXRhLmxlbmd0aCAhPSAwKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IGdldFNoZWxsSXRlbShkYXRhKTsKICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIFdpbmRvd3NFcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgYGNvdWxkIG5vdCBwYXJzZSBPcGVuU2F2ZSBzaGVsbGl0ZW0gZm9yICR7dmFsdWUudmFsdWV9OiAke2l0ZW19YAogICAgICAgICAgKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBkYXRhID0gaXRlbS5yZW1haW5pbmc7CiAgICAgICAgaXRlbXMucHVzaChKU09OLnBhcnNlKGl0ZW0uaXRlbSkpOwogICAgICB9CiAgICAgIGNvbnN0IG1ydSA9IGFzc2VtYmxlTXJ1KGl0ZW1zKTsKICAgICAgbXJ1cy5wdXNoKG1ydSk7CiAgICB9CiAgfQogIHJldHVybiBtcnVzOwp9CmZ1bmN0aW9uIGxhc3RWaXNpdE1ydShyZWdfZGF0YSkgewogIGNvbnN0IG1ydV9lbnRyaWVzID0gW107CiAgZm9yIChjb25zdCBlbnRyeSBvZiByZWdfZGF0YSkgewogICAgaWYgKCFlbnRyeS5wYXRoLmluY2x1ZGVzKAogICAgICAiU29mdHdhcmVcXE1pY3Jvc29mdFxcV2luZG93c1xcQ3VycmVudFZlcnNpb25cXEV4cGxvcmVyXFxDb21EbGczMlxcTGFzdFZpc2l0ZWRQaWRsTVJVIgogICAgKSkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIG1ydV9lbnRyaWVzLnB1c2goZW50cnkpOwogIH0KICBjb25zdCBtcnVzID0gW107CiAgZm9yIChjb25zdCBlbnRyaWVzIG9mIG1ydV9lbnRyaWVzKSB7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIGVudHJpZXMudmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZS52YWx1ZSA9PT0gIk1SVUxpc3RFeCIpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBkYXRhID0gZGVjb2RlKHZhbHVlLmRhdGEpOwogICAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEVuY29kaW5nRXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgYGNvdWxkIG5vdCBkZWNvZGUgTGFzdFZpc2l0ZWQga2V5ICR7dmFsdWUudmFsdWV9OiAke2RhdGF9YAogICAgICAgICk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgcmVtYWluaW5nID0gdGFrZVVudGlsKGRhdGEsIG5ldyBVaW50OEFycmF5KFswLCAwLCAwXSkpOwogICAgICBpZiAocmVtYWluaW5nIGluc3RhbmNlb2YgTm9tRXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBjb3VsZCBub3Qgbm9tIFVURjE2IGZpbGVuYW1lOiAke3JlbWFpbmluZ31gKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCByZW1haW5pbmdfaXRlbSA9IHRha2UocmVtYWluaW5nLnJlbWFpbmluZywgMyk7CiAgICAgIGlmIChyZW1haW5pbmdfaXRlbSBpbnN0YW5jZW9mIE5vbUVycm9yKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgY291bGQgbm90IG5vbSBlbmQgb2Ygc3RyaW5nOiAke3JlbWFpbmluZ31gKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBsZXQgaXRlbV9kYXRhID0gcmVtYWluaW5nX2l0ZW0ucmVtYWluaW5nOwogICAgICBjb25zdCBmaWxlbmFtZSA9IGV4dHJhY3RVdGYxNlN0cmluZyhyZW1haW5pbmcubm9tbWVkKTsKICAgICAgY29uc3QgaXRlbXMgPSBbXTsKICAgICAgd2hpbGUgKGl0ZW1fZGF0YS5sZW5ndGggIT0gMCkgewogICAgICAgIGNvbnN0IGl0ZW0gPSBnZXRTaGVsbEl0ZW0oaXRlbV9kYXRhKTsKICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIFdpbmRvd3NFcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgYGNvdWxkIG5vdCBwYXJzZSBMYXN0VmlzaXRlZCBzaGVsbGl0ZW0gZm9yICR7dmFsdWUudmFsdWV9OiAke2l0ZW19YAogICAgICAgICAgKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpdGVtX2RhdGEgPSBpdGVtLnJlbWFpbmluZzsKICAgICAgICBpdGVtcy5wdXNoKEpTT04ucGFyc2UoaXRlbS5pdGVtKSk7CiAgICAgIH0KICAgICAgY29uc3QgbXJ1ID0gYXNzZW1ibGVNcnUoaXRlbXMpOwogICAgICBtcnUuZmlsZW5hbWUgPSBmaWxlbmFtZTsKICAgICAgbXJ1cy5wdXNoKG1ydSk7CiAgICB9CiAgfQogIHJldHVybiBtcnVzOwp9CgovLyAuLi8uLi9Qcm9qZWN0cy9hcnRlbWlzLWFwaS9zcmMvd2luZG93cy9yZWdpc3RyeS9tcnUvcmVjZW50X2RvY3MudHMKZnVuY3Rpb24gcmVjZW50RG9jcyhyZWdfZGF0YSkgewogIGNvbnN0IG1ydV9lbnRyaWVzID0gW107CiAgZm9yIChjb25zdCBlbnRyeSBvZiByZWdfZGF0YSkgewogICAgaWYgKCFlbnRyeS5wYXRoLmluY2x1ZGVzKAogICAgICAiXFxTb2Z0d2FyZVxcTWljcm9zb2Z0XFxXaW5kb3dzXFxDdXJyZW50VmVyc2lvblxcRXhwbG9yZXJcXFJlY2VudERvY3MiCiAgICApKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgbXJ1X2VudHJpZXMucHVzaChlbnRyeSk7CiAgfQogIGNvbnN0IG1ydXMgPSBbXTsKICBmb3IgKGNvbnN0IGVudHJpZXMgb2YgbXJ1X2VudHJpZXMpIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgZW50cmllcy52YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlLnZhbHVlID09PSAiTVJVTGlzdEV4IikgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGRhdGEgPSBkZWNvZGUodmFsdWUuZGF0YSk7CiAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgRW5jb2RpbmdFcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICBgY291bGQgbm90IGRlY29kZSByZWNlbnQgZG9jcyBrZXkgJHt2YWx1ZS52YWx1ZX06ICR7ZGF0YX1gCiAgICAgICAgKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCByZW1haW5pbmcgPSB0YWtlVW50aWwoZGF0YSwgbmV3IFVpbnQ4QXJyYXkoWzAsIDAsIDBdKSk7CiAgICAgIGlmIChyZW1haW5pbmcgaW5zdGFuY2VvZiBOb21FcnJvcikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYGNvdWxkIG5vdCBub20gVVRGMTYgZmlsZW5hbWU6ICR7cmVtYWluaW5nfWApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHJlbWFpbmluZ19pdGVtID0gdGFrZShyZW1haW5pbmcucmVtYWluaW5nLCAzKTsKICAgICAgaWYgKHJlbWFpbmluZ19pdGVtIGluc3RhbmNlb2YgTm9tRXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBjb3VsZCBub3Qgbm9tIGVuZCBvZiBzdHJpbmc6ICR7cmVtYWluaW5nfWApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxldCBpdGVtX2RhdGEgPSByZW1haW5pbmdfaXRlbS5yZW1haW5pbmc7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gZXh0cmFjdFV0ZjE2U3RyaW5nKHJlbWFpbmluZy5ub21tZWQpOwogICAgICBjb25zdCBpdGVtcyA9IFtdOwogICAgICB3aGlsZSAoaXRlbV9kYXRhLmxlbmd0aCAhPSAwKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IGdldFNoZWxsSXRlbShpdGVtX2RhdGEpOwogICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgV2luZG93c0Vycm9yKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICBgY291bGQgbm90IHBhcnNlIHJlY2VudCBkb2NzIHNoZWxsaXRlbSBmb3IgJHt2YWx1ZS52YWx1ZX06ICR7aXRlbX1gCiAgICAgICAgICApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGl0ZW1fZGF0YSA9IGl0ZW0ucmVtYWluaW5nOwogICAgICAgIGl0ZW1zLnB1c2goSlNPTi5wYXJzZShpdGVtLml0ZW0pKTsKICAgICAgfQogICAgICBjb25zdCBtcnUgPSBhc3NlbWJsZU1ydShpdGVtcyk7CiAgICAgIG1ydS5maWxlbmFtZSA9IGZpbGVuYW1lOwogICAgICBtcnVzLnB1c2gobXJ1KTsKICAgIH0KICB9CiAgcmV0dXJuIG1ydXM7Cn0KCi8vIC4uLy4uL1Byb2plY3RzL2FydGVtaXMtYXBpL3NyYy93aW5kb3dzL3JlZ2lzdHJ5L3JlY2VudGx5X3VzZWQudHMKZnVuY3Rpb24gcGFyc2VNcnUobnR1c2VyX3BhdGgpIHsKICBjb25zdCByZWdfZGF0YSA9IGdldFJlZ2lzdHJ5KG50dXNlcl9wYXRoKTsKICBpZiAocmVnX2RhdGEgaW5zdGFuY2VvZiBXaW5kb3dzRXJyb3IpIHsKICAgIHJldHVybiBuZXcgV2luZG93c0Vycm9yKAogICAgICAiTVJVIiwKICAgICAgYENvdWxkIG5vdCBwYXJzZSBSZWdpc3RyeSAke250dXNlcl9wYXRofTogJHtyZWdfZGF0YX1gCiAgICApOwogIH0KICBjb25zdCBjb21tb24gPSBvcGVuU2F2ZU1ydShyZWdfZGF0YSk7CiAgaWYgKGNvbW1vbiBpbnN0YW5jZW9mIFdpbmRvd3NFcnJvcikgewogICAgcmV0dXJuIG5ldyBXaW5kb3dzRXJyb3IoCiAgICAgICJNUlUiLAogICAgICBgQ291bGQgbm90IGdldCBPcGVuU2F2ZSBNUlUgZW50cmllczogJHtjb21tb259YAogICAgKTsKICB9CiAgY29uc3QgbXJ1cyA9IFtdOwogIGNvbnN0IG9wZW5fc2F2ZV9tcnUgPSB7CiAgICBudHVzZXJfcGF0aCwKICAgIGtpbmQ6ICJPcGVuU2F2ZSIgLyogT1BFTlNBVkUgKi8sCiAgICBtcnU6IGNvbW1vbgogIH07CiAgbXJ1cy5wdXNoKG9wZW5fc2F2ZV9tcnUpOwogIGNvbnN0IGxhc3RfdmlzaXQgPSBsYXN0VmlzaXRNcnUocmVnX2RhdGEpOwogIGlmIChsYXN0X3Zpc2l0IGluc3RhbmNlb2YgV2luZG93c0Vycm9yKSB7CiAgICByZXR1cm4gbmV3IFdpbmRvd3NFcnJvcigKICAgICAgIk1SVSIsCiAgICAgIGBDb3VsZCBub3QgZ2V0IExhc3RWaXNpdGVkIE1SVSBlbnRyaWVzOiAke2NvbW1vbn1gCiAgICApOwogIH0KICBjb25zdCBsYXN0X3Zpc2l0X21ydSA9IHsKICAgIG50dXNlcl9wYXRoLAogICAga2luZDogIkxhc3RWaXNpc3RlZCIgLyogTEFTVFZJU0lURUQgKi8sCiAgICBtcnU6IGxhc3RfdmlzaXQKICB9OwogIG1ydXMucHVzaChsYXN0X3Zpc2l0X21ydSk7CiAgY29uc3QgcmVjZW50X2RvY3MgPSByZWNlbnREb2NzKHJlZ19kYXRhKTsKICBpZiAocmVjZW50X2RvY3MgaW5zdGFuY2VvZiBXaW5kb3dzRXJyb3IpIHsKICAgIHJldHVybiBuZXcgV2luZG93c0Vycm9yKAogICAgICAiTVJVIiwKICAgICAgYENvdWxkIG5vdCBnZXQgUmVjZW50RG9jcyBNUlUgZW50cmllczogJHtjb21tb259YAogICAgKTsKICB9CiAgY29uc3QgcmVjZW50X2RvY3NfbXJ1ID0gewogICAgbnR1c2VyX3BhdGgsCiAgICBraW5kOiAiUmVjZW50RG9jcyIgLyogUkVDRU5URE9DUyAqLywKICAgIG1ydTogcmVjZW50X2RvY3MKICB9OwogIG1ydXMucHVzaChyZWNlbnRfZG9jc19tcnUpOwogIHJldHVybiBtcnVzOwp9CmZ1bmN0aW9uIGFzc2VtYmxlTXJ1KGl0ZW1zKSB7CiAgY29uc3QgcGF0aHMgPSBbXTsKICBmb3IgKGNvbnN0IGl0ZW0yIG9mIGl0ZW1zKSB7CiAgICBwYXRocy5wdXNoKGl0ZW0yLnZhbHVlLnJlcGxhY2VBbGwoIlxcXFwiLCAiIikpOwogIH0KICBjb25zdCBpdGVtID0gaXRlbXNbaXRlbXMubGVuZ3RoIC0gMV07CiAgY29uc3QgZW50cnkgPSB7CiAgICBmaWxlbmFtZTogaXRlbS52YWx1ZSwKICAgIHBhdGg6IHBhdGhzLmpvaW4oIlxcIiksCiAgICBtb2RpZmllZDogaXRlbS5tb2RpZmllZCwKICAgIGNyZWF0ZWQ6IGl0ZW0uY3JlYXRlZCwKICAgIGFjY2Vzc2VkOiBpdGVtLmFjY2Vzc2VkLAogICAgaXRlbXMKICB9OwogIHJldHVybiBlbnRyeTsKfQoKLy8gbWFpbi50cwpmdW5jdGlvbiBtYWluKCkgewogIGNvbnN0IHBhdGhzID0gZ2xvYigiQzpcXFVzZXJzXFwqXFxOVFVTRVIuREFUIik7CiAgaWYgKHBhdGhzIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoYG9vcHM6ICR7cGF0aHN9YCk7CiAgICByZXR1cm47CiAgfQogIGZvciAoY29uc3QgcGF0aCBvZiBwYXRocykgewogICAgY29uc3QgX3Jlc3VsdCA9IHBhcnNlTXJ1KHBhdGguZnVsbF9wYXRoKTsKICAgIGJyZWFrOwogIH0KfQptYWluKCk7Cg==";
        let mut output = output_options("runtime_test", "local", "./tmp", false);
        let script = JSScript {
            name: String::from("shellitems"),
            script: test.to_string(),
        };
        execute_script(&mut output, &script).unwrap();
    }
}
