system = "macos"

[output]
name = "plist_data"
directory = "./tmp"
format = "json"
compress = false
endpoint_id = "6c51b123-1522-4572-9f2a-0bd5abd81b82"
collection_id = 1
output = "local"

[[artifacts]]
artifact_name = "script"
[artifacts.script]
name = "all_usr_plist_files"
# Parses all plist files in /usr/%
script = "Ly8gaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3B1ZmZ5Y2lkL2FydGVtaXMtYXBpL21hc3Rlci9zcmMvbWFjb3MvcGxpc3QudHMKZnVuY3Rpb24gZ2V0UGxpc3QocGF0aCkgewogIGNvbnN0IGRhdGEgPSBEZW5vLmNvcmUub3BzLmdldF9wbGlzdChwYXRoKTsKICBpZiAoZGF0YSA9PT0gIiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBjb25zdCBwbGlzdF9kYXRhID0gSlNPTi5wYXJzZShkYXRhKTsKICByZXR1cm4gcGxpc3RfZGF0YTsKfQoKLy8gaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3B1ZmZ5Y2lkL2FydGVtaXMtYXBpL21hc3Rlci9zcmMvc3lzdGVtL291dHB1dC50cwpmdW5jdGlvbiBvdXRwdXRSZXN1bHRzKGRhdGEsIGRhdGFfbmFtZSwgb3V0cHV0KSB7CiAgY29uc3Qgb3V0cHV0X3N0cmluZyA9IEpTT04uc3RyaW5naWZ5KG91dHB1dCk7CiAgY29uc3Qgc3RhdHVzID0gRGVuby5jb3JlLm9wcy5vdXRwdXRfcmVzdWx0cygKICAgIGRhdGEsCiAgICBkYXRhX25hbWUsCiAgICBvdXRwdXRfc3RyaW5nLAogICk7CiAgcmV0dXJuIHN0YXR1czsKfQoKLy8gaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3B1ZmZ5Y2lkL2FydGVtaXMtYXBpL21hc3Rlci9zcmMvZmlsZXN5c3RlbS9kaXJlY3RvcnkudHMKYXN5bmMgZnVuY3Rpb24gcmVhZERpcihwYXRoKSB7CiAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoYXdhaXQgZnMucmVhZERpcihwYXRoKSk7CiAgcmV0dXJuIGRhdGE7Cn0KCi8vIG1haW4udHMKYXN5bmMgZnVuY3Rpb24gbWFpbigpIHsKICBjb25zdCBzdGFydF9wYXRoID0gIi91c3IiOwogIGNvbnN0IHBsaXN0X2ZpbGVzID0gW107CiAgYXdhaXQgcmVjdXJzZV9kaXIocGxpc3RfZmlsZXMsIHN0YXJ0X3BhdGgpOwogIHJldHVybiBwbGlzdF9maWxlczsKfQphc3luYyBmdW5jdGlvbiByZWN1cnNlX2RpcihwbGlzdF9maWxlcywgc3RhcnRfcGF0aCkgewogIGlmIChwbGlzdF9maWxlcy5sZW5ndGggPiAyMCkgewogICAgY29uc3Qgb3V0ID0gewogICAgICBuYW1lOiAiYXJ0ZW1pc19wbGlzdCIsCiAgICAgIGRpcmVjdG9yeTogIi4vdG1wIiwKICAgICAgZm9ybWF0OiAianNvbiIsIC8qIEpTT04gKi8KICAgICAgY29tcHJlc3M6IGZhbHNlLAogICAgICBlbmRwb2ludF9pZDogImFueXRoaW5nLWktd2FudCIsCiAgICAgIGNvbGxlY3Rpb25faWQ6IDEsCiAgICAgIG91dHB1dDogImxvY2FsIiwgLyogTE9DQUwgKi8KICAgIH07CiAgICBjb25zdCBzdGF0dXMgPSBvdXRwdXRSZXN1bHRzKAogICAgICBKU09OLnN0cmluZ2lmeShwbGlzdF9maWxlcyksCiAgICAgICJhcnRlbWlzX2luZm8iLAogICAgICBvdXQsCiAgICApOwogICAgaWYgKCFzdGF0dXMpIHsKICAgICAgY29uc29sZS5sb2coIkNvdWxkIG5vdCBvdXRwdXQgdG8gbG9jYWwgZGlyZWN0b3J5Iik7CiAgICB9CiAgICBwbGlzdF9maWxlcyA9IFtdOwogIH0KICBmb3IgKGNvbnN0IGVudHJ5IG9mIGF3YWl0IHJlYWREaXIoc3RhcnRfcGF0aCkpIHsKICAgIGNvbnN0IHBsaXN0X3BhdGggPSBgJHtzdGFydF9wYXRofS8ke2VudHJ5LmZpbGVuYW1lfWA7CiAgICBpZiAoZW50cnkuaXNfZmlsZSAmJiBlbnRyeS5maWxlbmFtZS5lbmRzV2l0aCgicGxpc3QiKSkgewogICAgICBjb25zdCBkYXRhID0gZ2V0UGxpc3QocGxpc3RfcGF0aCk7CiAgICAgIGlmIChkYXRhID09PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgcGxpc3RfaW5mbyA9IHsKICAgICAgICBwbGlzdF9jb250ZW50OiBkYXRhLAogICAgICAgIGZpbGU6IHBsaXN0X3BhdGgsCiAgICAgIH07CiAgICAgIHBsaXN0X2ZpbGVzLnB1c2gocGxpc3RfaW5mbyk7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgaWYgKGVudHJ5LmlzX2RpcmVjdG9yeSkgewogICAgICBhd2FpdCByZWN1cnNlX2RpcihwbGlzdF9maWxlcywgcGxpc3RfcGF0aCk7CiAgICB9CiAgfQp9Cm1haW4oKTsK"
