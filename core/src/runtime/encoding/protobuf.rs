use crate::utils::encoding::parse_protobuf;
use deno_core::{error::AnyError, op2, JsBuffer};

#[op2]
#[string]
/// Parse Protobuf data
pub(crate) fn js_parse_protobuf(#[buffer] data: JsBuffer) -> Result<String, AnyError> {
    let result = parse_protobuf(&data)?;

    let res = serde_json::to_string(&result)?;

    Ok(res)
}

#[cfg(test)]
mod tests {
    use crate::{
        runtime::deno::execute_script, structs::artifacts::runtime::script::JSScript,
        structs::toml::Output,
    };

    fn output_options(name: &str, output: &str, directory: &str, compress: bool) -> Output {
        Output {
            name: name.to_string(),
            directory: directory.to_string(),
            format: String::from("json"),
            compress,
            url: Some(String::new()),
            api_key: Some(String::new()),
            endpoint_id: String::from("abcd"),
            collection_id: 0,
            output: output.to_string(),
            filter_name: None,
            filter_script: None,
            logging: None,
        }
    }

    #[test]
    fn test_js_parse_protobuf() {
        let test = "dmFyIHU9Y2xhc3MgZXh0ZW5kcyBFcnJvcntuYW1lO21lc3NhZ2U7Y29uc3RydWN0b3IoZSxyKXtzdXBlcigpLHRoaXMubmFtZT1lLHRoaXMubWVzc2FnZT1yfX07dmFyIGc9Y2xhc3MgZXh0ZW5kcyB1e307dmFyIHM9Y2xhc3MgZXh0ZW5kcyB1e307ZnVuY3Rpb24gcCh0KXt0cnl7cmV0dXJuIGVuY29kaW5nLmF0b2IodCl9Y2F0Y2goZSl7cmV0dXJuIG5ldyBzKCJCQVNFNjQiLGBmYWlsZWQgdG8gZGVjb2RlICR7dH06ICR7ZX1gKX19ZnVuY3Rpb24gbSh0KXtyZXR1cm4gZW5jb2RpbmcuZXh0cmFjdF91dGY4X3N0cmluZyh0KX12YXIgbz1jbGFzcyBleHRlbmRzIHV7fTtmdW5jdGlvbiBoKHQsZSl7dHJ5e3JldHVybiBEZW5vLmNvcmUub3BzLmpzX25vbV91bnNpZ25lZF9mb3VyX2J5dGVzKHQsZSl9Y2F0Y2gocil7cmV0dXJuIG5ldyBvKCJOT00iLGBmYWlsZWQgdG8gbm9tIHVuc2lnbmVkIGZvdXIgYnl0ZTogJHtyfWApfX1mdW5jdGlvbiBkKHQsZSl7aWYoZTwwKXJldHVybiBuZXcgbygiTk9NIiwicHJvdmlkZWQgbmVnYXRpdmUgbnVtYmVyIik7aWYodHlwZW9mIHQ9PSJzdHJpbmciKXRyeXtsZXQgcj1EZW5vLmNvcmUub3BzLmpzX25vbV90YWtlX3N0cmluZyh0LGUpO3JldHVybiBKU09OLnBhcnNlKHIpfWNhdGNoKHIpe3JldHVybiBuZXcgbygiTk9NIixgY291bGQgbm90IHRha2Ugc3RyaW5nICR7cn1gKX10cnl7cmV0dXJuIERlbm8uY29yZS5vcHMuanNfbm9tX3Rha2VfYnl0ZXModCxlKX1jYXRjaChyKXtyZXR1cm4gbmV3IG8oIk5PTSIsYGNvdWxkIG5vdCB0YWtlIGJ5dGVzICR7cn1gKX19ZnVuY3Rpb24gXyh0LGUpe2lmKHR5cGVvZiB0IT10eXBlb2YgZSlyZXR1cm4gbmV3IG8oIk5PTSIsImRhdGEgYW5kIGlucHV0IG11c3QgYmUgbWF0Y2hpbmcgdHlwZXMiKTtpZih0eXBlb2YgdD09InN0cmluZyImJnR5cGVvZiBlPT0ic3RyaW5nIil0cnl7bGV0IHI9RGVuby5jb3JlLm9wcy5qc19ub21fdGFrZV91bnRpbF9zdHJpbmcodCxlKTtyZXR1cm4gSlNPTi5wYXJzZShyKX1jYXRjaChyKXtyZXR1cm4gbmV3IG8oIk5PTSIsYGNvdWxkIG5vdCB0YWtlIHVudGlsIHN0cmluZyAke3J9YCl9dHJ5e3JldHVybiBEZW5vLmNvcmUub3BzLmpzX25vbV90YWtlX3VudGlsX2J5dGVzKHQsZSl9Y2F0Y2gocil7cmV0dXJuIG5ldyBvKCJOT00iLGBjb3VsZCBub3QgdGFrZSB1bnRpbCBieXRlcyAke3J9YCl9fWZ1bmN0aW9uIGwodCl7dD10LnJlcGxhY2VBbGwoIl8iLCIrIikucmVwbGFjZUFsbCgiLSIsIi8iKSx0PXQucmVwbGFjZUFsbCgiJTNEIiwiPSIpLnJlcGxhY2VBbGwoIiUyRiIsIisiKTtsZXQgZT1wKHQpO3JldHVybiBlIGluc3RhbmNlb2YgcyYmKGU9cChgJHt0fT1gKSxlIGluc3RhbmNlb2YgcyYmKGU9cChgJHt0fT09YCkpKSxlfWZ1bmN0aW9uIHcodCl7cmV0dXJuIHQubGVuZ3RoIT0zMj90OmAke3Quc2xpY2UoMCw4KX0tJHt0LnNsaWNlKDgsMTIpfS0ke3Quc2xpY2UoMTIsMTYpfS0ke3Quc2xpY2UoMTYsMjApfS0ke3Quc2xpY2UoMjApfWB9dmFyIHk9Y2xhc3N7dXJsO2NvbnN0cnVjdG9yKGUpe3RoaXMudXJsPWV9cGFyc2VCaW5nKCl7Zm9yKGxldCBlIG9mIHRoaXMudXJsLnF1ZXJ5X3BhaXJzKXtsZXRbciwuLi5pXT1lLnNwbGl0KCI9Iiksbj1pLmpvaW4oIj0iKTtzd2l0Y2goci50b0xvd2VyQ2FzZSgpKXtjYXNlImZvcm0iOntpZihuPT09IiIpYnJlYWs7dGhpcy51cmxbcl09bjticmVha31jYXNlInNrIjp7aWYobj09PSIiKWJyZWFrO3RoaXMudXJsW3JdPW47YnJlYWt9Y2FzZSJnaHBsIjp7aWYobj09PSIiKWJyZWFrO3RoaXMudXJsW3JdPW47YnJlYWt9Y2FzZSJxIjp7dGhpcy51cmwuc2VhcmNoX3F1ZXJ5PW47YnJlYWt9Y2FzZSJzcCI6e3RoaXMudXJsLnN1Z2dlc3RlZF9wb3NpdGlvbj1uO2JyZWFrfWNhc2UibHEiOnt0aGlzLnVybFtyXT1uO2JyZWFrfWNhc2UicHEiOnt0aGlzLnVybC5wYXJ0aWFsX3F1ZXJ5PW47YnJlYWt9Y2FzZSJzYyI6e3RoaXMudXJsLnN1Z2dlc3Rpb25fY291bnQ9bjticmVha31jYXNlInFzIjp7dGhpcy51cmwuc3VnZ2VzdGlvbl90eXBlPW47YnJlYWt9Y2FzZSJjdmlkIjp7bGV0IGM9bjtpZihjLmxlbmd0aCE9MzIpe3RoaXMudXJsLmNvbnZlcnNhdGlvbl9pZD1uO2JyZWFrfXRoaXMudXJsLmNvbnZlcnNhdGlvbl9pZD13KGMpO2JyZWFrfWNhc2UiZ2hhY2MiOnt0aGlzLnVybFtyXT1uO2JyZWFrfWNhc2UiZmlsdGVycyI6e2xldCBjPV8obiwnIicpO2lmKGMgaW5zdGFuY2VvZiBvKWJyZWFrO2xldCBhPV8oYy5yZW1haW5pbmcuc2xpY2UoMSksJyInKTtpZihhIGluc3RhbmNlb2YgbylicmVhaztsZXQgZj1sKGEubm9tbWVkKTtpZihmIGluc3RhbmNlb2YgcylicmVhazt0aGlzLnVybFtyXT1tKGYpLnNwbGl0KCIhIik7bGV0IGI9YS5yZW1haW5pbmcucmVwbGFjZUFsbCgnIicsIiIpLnRyaW0oKS5zcGxpdCgiICIpO2ZvcihsZXQgRyBvZiBiKXtsZXQgTj1HLnNwbGl0KCI6Iik7dGhpcy51cmxbYGZpbHRlcnNfJHtOLmF0KDApPz8iIn1gXT1OLmF0KDEpfWJyZWFrfWNhc2UiZ2hzaCI6e3RoaXMudXJsW3JdPW47YnJlYWt9Y2FzZSB2b2lkIDA6YnJlYWs7ZGVmYXVsdDp7Y29uc29sZS53YXJuKGB1bmtub3duIGJpbmcga2V5OiAke3J9LiBWYWx1ZTogJHtufWApLHRoaXMudXJsW3JdPW47YnJlYWt9fX19fTt2YXIgQT1jbGFzc3t1cmw7Y29uc3RydWN0b3IoZSl7dGhpcy51cmw9ZX1wYXJzZUR1Y2tEdWNrR28oKXtmb3IobGV0IGUgb2YgdGhpcy51cmwucXVlcnlfcGFpcnMpe2xldCByPWUuc3BsaXQoIj0iKSxpPXIuYXQoMCk7c3dpdGNoKGkpe2Nhc2UiaWEiOnt0aGlzLnVybC5zZWFyY2hfdHlwZT1yLmF0KDEpO2JyZWFrfWNhc2UidCI6e2lmKHIuYXQoMSk9PT0iaF8iKXt0aGlzLnVybC50cmFja2VyPSJob21lcGFnZSI7YnJlYWt9dGhpcy51cmwudHJhY2tlcj1yLmF0KDEpO2JyZWFrfWNhc2UicSI6e3RoaXMudXJsLnNlYXJjaF9xdWVyeT1yLmF0KDEpO2JyZWFrfWNhc2UiZGYiOnt0aGlzLnVybC5zZWFyY2hfcGVyaW9kPXIuYXQoMSk7YnJlYWt9Y2FzZSJpYXgiOnt0aGlzLnVybC5zZWFyY2hfdHlwZV9leHBhbmRlZF92aWV3PXIuYXQoMSk7YnJlYWt9Y2FzZSJpYXhtIjp7dGhpcy51cmwuc2VhcmNoX3R5cGVfZXhwYW5kZWRfdmlld19tb2JpbGU9ci5hdCgxKTticmVha31jYXNlImJib3giOnt0aGlzLnVybC5ib3VuZGluZ19ib3g9ci5hdCgxKTticmVha31jYXNlImlhciI6e3RoaXMudXJsLnNlYXJjaF9yZWZlcnJlcj1yLmF0KDEpO2JyZWFrfWNhc2Ugdm9pZCAwOmJyZWFrO2RlZmF1bHQ6e2NvbnNvbGUud2FybihgdW5rbm93biBkdWNrZHVja2dvIGtleTogJHtpfS4gVmFsdWU6ICR7ci5hdCgxKX1gKTticmVha319fX19O2Z1bmN0aW9uIHgodCl7dHJ5e2xldCBlPWVuY29kaW5nLnBhcnNlX3Byb3RvYnVmKHQpO3JldHVybiBKU09OLnBhcnNlKGUpfWNhdGNoKGUpe3JldHVybiBuZXcgcygiUFJPVE9CVUYiLGBmYWlsZWQgdG8gcGFyc2UgcHJvdG9idWY6ICR7ZX1gKX19ZnVuY3Rpb24gQih0KXtpZih0PT09MHx8dD09PTBuKXJldHVybiBuZXcgRGF0ZShOdW1iZXIodCkpLnRvSVNPU3RyaW5nKCk7bGV0IGU9MTMscj0xZTM7aWYodHlwZW9mIHQ9PSJudW1iZXIiJiZ0LnRvU3RyaW5nKCkubGVuZ3RoPGUpcmV0dXJuIG5ldyBEYXRlKHQqcikudG9JU09TdHJpbmcoKTtpZih0LnRvU3RyaW5nKCkubGVuZ3RoPDE2KXJldHVybiBuZXcgRGF0ZShOdW1iZXIodCkpLnRvSVNPU3RyaW5nKCk7bGV0IG49MTk7aWYodC50b1N0cmluZygpLmxlbmd0aDxuKXtsZXQgYT1CaWdJbnQodCkvQmlnSW50KHIpO3JldHVybiBuZXcgRGF0ZShOdW1iZXIoYSkpLnRvSVNPU3RyaW5nKCl9aWYodC50b1N0cmluZygpLmxlbmd0aD09PW4pe2xldCBhPUJpZ0ludCh0KS9CaWdJbnQocipyKTtyZXR1cm4gbmV3IERhdGUoTnVtYmVyKGEpKS50b0lTT1N0cmluZygpfWNvbnNvbGUud2FybihgUmVjZWl2ZWQgdmVyeSBsYXJnZSBudW1iZXI6ICAke3R9LiBDb252ZXJ0aW5nIHRvIG1heCBOdW1iZXIgdHlwZSB2YWx1ZWApO2xldCBjPUJpZ0ludCh0KS9CaWdJbnQocik7cmV0dXJuIG5ldyBEYXRlKE51bWJlcihjKSkudG9JU09TdHJpbmcoKX12YXIgaz1jbGFzc3t1cmw7Y29uc3RydWN0b3IoZSl7dGhpcy51cmw9ZX1wYXJzZUdvb2dsZSgpe2ZvcihsZXQgZSBvZiB0aGlzLnVybC5xdWVyeV9wYWlycyl7bGV0IHI9ZS5zcGxpdCgiPSIpLGk9ci5hdCgwKTtzd2l0Y2goaSl7Y2FzZSJlaSI6e2xldCBuPXIuYXQoMSk7aWYobj09PXZvaWQgMClicmVhaztsZXQgYz1sKG4pO2lmKGMgaW5zdGFuY2VvZiBzKWJyZWFrO2xldCBhPWgoYywxKTtpZihhIGluc3RhbmNlb2YgbylicmVhazt0aGlzLnVybC5zZWFyY2hfdGltZT1CKGEudmFsdWUpO2JyZWFrfWNhc2UicSI6e3RoaXMudXJsLnNlYXJjaF9xdWVyeT1yLmF0KDEpO2JyZWFrfWNhc2UiaGwiOnt0aGlzLnVybC5ob3N0X2xhbmd1YWdlPXIuYXQoMSk7YnJlYWt9Y2FzZSJ1YWN0Ijp7dGhpcy51cmxbaV09ci5hdCgxKTticmVha31jYXNlInNjYV9lc3YiOnt0aGlzLnVybFtpXT1yLmF0KDEpO2JyZWFrfWNhc2Uib3EiOnt0aGlzLnVybC5vcmlnaW5hbF9xdWVyeT1yLmF0KDEpO2JyZWFrfWNhc2Uic291cmNlIjp7aWYoci5hdCgxKT09PSJocCIpe3RoaXMudXJsLnNvdXJjZV9vZl9zZWFyY2g9ImhvbWVwYWdlIjticmVha310aGlzLnVybC5zb3VyY2Vfb2Zfc2VhcmNoPXIuYXQoMSk7YnJlYWt9Y2FzZSJnc19scCI6e2xldCBuPXIuYXQoMSk7aWYobj09PXZvaWQgMClicmVhaztsZXQgYz1sKG4pO2lmKGMgaW5zdGFuY2VvZiBzKWJyZWFrO2xldCBhPXgoYyk7aWYoYSBpbnN0YW5jZW9mIHMpYnJlYWs7dGhpcy51cmwuZ3NfbHA9YTticmVha31jYXNlInZlZCI6e2xldCBuPXIuYXQoMSk7aWYobj09PXZvaWQgMHx8bi5zdGFydHNXaXRoKCIxIikpYnJlYWs7bGV0IGM9bChuLnN1YnN0cmluZygxKSk7aWYoYyBpbnN0YW5jZW9mIHMpYnJlYWs7bGV0IGE9eChjKTtpZihhIGluc3RhbmNlb2YgcylicmVhazt0aGlzLnVybC5saW5rX3RyYWNraW5nPWE7YnJlYWt9Y2FzZSJzY2xpZW50Ijp7bGV0IG49ci5hdCgxKTtzd2l0Y2gobil7Y2FzZSJnd3Mtd2l6LXNlcnAiOnt0aGlzLnVybC5zZWFyY2hfY2xpZW50PSJHb29nbGUgV2ViIFNlYXJjaCBXaXphcmQsIFNlYXJjaCBFbmdpbmUgUmVzdWx0cyBQYWdlIjticmVha31jYXNlImd3cy13aXoiOnt0aGlzLnVybC5zZWFyY2hfY2xpZW50PSJHb29nbGUgV2ViIFNlYXJjaCBXaXphcmQiO2JyZWFrfWRlZmF1bHQ6e3RoaXMudXJsLnNlYXJjaF9jbGllbnQ9bjticmVha319YnJlYWt9Y2FzZSB2b2lkIDA6YnJlYWs7ZGVmYXVsdDp7Y29uc29sZS53YXJuKGB1bmtub3duIGdvb2dsZSBrZXk6ICR7aX0uIFZhbHVlOiAke3IuYXQoMSl9YCksdGhpcy51cmxbaV09ci5hdCgxKTticmVha319fX19O2Z1bmN0aW9uIFModCxlKXtyZXR1cm4gdD09PTA/ZW5jb2RpbmcuYnl0ZXNfdG9fYmVfZ3VpZChlKTplbmNvZGluZy5ieXRlc190b19sZV9ndWlkKGUpfXZhciBVPWNsYXNze3VybDtjb25zdHJ1Y3RvcihlKXt0aGlzLnVybD1lfXBhcnNlT3V0bG9vaygpe2lmKHRoaXMudXJsLnVybC5pbmNsdWRlcygiaW5ib3giKSl7bGV0IGU9bCh0aGlzLnVybC5sYXN0X3NlZ21lbnQpO2lmKGUgaW5zdGFuY2VvZiBzKXJldHVybjtsZXQgcj1oKGUsMSk7aWYociBpbnN0YW5jZW9mIG8pcmV0dXJuO2xldCBpPTgsbj1kKHIucmVtYWluaW5nLGkpO2lmKG4gaW5zdGFuY2VvZiBvKXJldHVybjtsZXQgYz1tKG4ubm9tbWVkLnNsaWNlKDMpKTtpZihpPTE0LG49ZChuLnJlbWFpbmluZyxpKSxuIGluc3RhbmNlb2YgbylyZXR1cm47bGV0IGE9bShuLm5vbW1lZCk7aT04O2xldCBmPWQobi5yZW1haW5pbmcsaSk7aWYoZiBpbnN0YW5jZW9mIG8pcmV0dXJuO2xldCBiPWQoZi5yZW1haW5pbmcsMTYpO2lmKGIgaW5zdGFuY2VvZiBvKXJldHVybjt0aGlzLnVybC5ndWlkPVMoMSxiLm5vbW1lZCksdGhpcy51cmwuYWNjb3VudF9pZD1gJHtjfS0ke2F9LTAwYH19fTt2YXIgRT1jbGFzc3t1cmw7Y29uc3RydWN0b3IoZSl7dGhpcy51cmw9ZX1wYXJzZVVybCgpe2xldCBlPXRoaXMuZXh0cmFjdFVybCgpO3JldHVybiBlIGluc3RhbmNlb2YgZz9lOnRoaXMuZXh0cmFjdERhdGEoZSl9ZXh0cmFjdERhdGEoZSl7cmV0dXJuIGUuZG9tYWluLmluY2x1ZGVzKCJkdWNrZHVja2dvLmNvbSIpP25ldyBBKGUpLnBhcnNlRHVja0R1Y2tHbygpOmUuZG9tYWluLmluY2x1ZGVzKCJnb29nbGUuY29tIik/bmV3IGsoZSkucGFyc2VHb29nbGUoKTplLmRvbWFpbi5pbmNsdWRlcygib3V0bG9vay5saXZlLmNvbSIpP25ldyBVKGUpLnBhcnNlT3V0bG9vaygpOmUuZG9tYWluLmluY2x1ZGVzKCJiaW5nLmNvbSIpJiZuZXcgeShlKS5wYXJzZUJpbmcoKSxlfWV4dHJhY3RVcmwoKXt0cnl7bGV0IGU9RGVuby5jb3JlLm9wcy51cmxfcGFyc2UodGhpcy51cmwpLHI9SlNPTi5wYXJzZShlKTtyZXR1cm4gci51cmw9dGhpcy51cmwsci5sYXN0X3NlZ21lbnQ9ci5zZWdtZW50cy5hdCgtMSk/PyIiLHJ9Y2F0Y2goZSl7cmV0dXJuIG5ldyBnKCJVUkxfUEFSU0UiLGBmYWlsZWQgdG8gcGFyc2UgdXJsIGZpbGUgJHt0aGlzLnVybH06ICR7ZX1gKX19fTtmdW5jdGlvbiBPKCl7bGV0IGU9bmV3IEUoImh0dHBzOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9YXJ0ZW1pcytkZmlyK2dpdGh1YiZzY2FfZXN2PWI1MWRjOGFkN2IyNjRhOTkmc291cmNlPWhwJmVpPURWR0VaN1BnT3ZHZjVOb1AwLWpnb0FzJmlmbHNpZz1BTDloYmRnQUFBQUFaNFJmSFdSbHVDWVdUa256TDFRZnJMbURFMGxsUXRadyZ2ZWQ9MGFoVUtFd2p6bXEzdXFfR0tBeFh4RDFrRkhWTTBHTFFRNGRVRENCQSZ1YWN0PTUmb3E9YXJ0ZW1pcytkZmlyK2dpdGh1YiZnc19scD1FZ2RuZDNNdGQybDZJaE5oY25SbGJXbHpJR1JtYVhJZ1oybDBhSFZpTWdVUUlSaWdBVElGRUNFWW9BRXlCUkFoR0tBQk1nVVFJUmlnQVRJRkVDRVlud1V5QlJBaEdKOEZTSVVhVUFCWW9SbHdBSGdBa0FFQW1BRlVvQUhIQjZvQkFqRTV1QUVEeUFFQS1BRUJtQUlUb0FMNUI4SUNFUkF1R0lBRUdMRURHTkVER0lNQkdNY0J3Z0lMRUFBWWdBUVlzUU1ZZ3dIQ0Fnc1FMaGlBQkJpeEF4aURBY0lDRGhBdUdJQUVHTEVER0lNQkdJb0Z3Z0lPRUM0WWdBUVlzUU1ZMFFNWXh3SENBZ3NRTGhpQUJCalJBeGpIQWNJQ0RoQUFHSUFFR0xFREdJTUJHSW9Gd2dJSUVDNFlnQVFZc1FQQ0FnVVFMaGlBQk1JQ0RoQXVHSUFFR01jQkdJNEZHSzhCd2dJSUVBQVlnQVFZc1FQQ0FnVVFBQmlBQk1JQ0VSQXVHSUFFR0xFREdNY0JHSTRGR0s4QndnSUxFQzRZZ0FRWXNRTVkxQUxDQWdZUUFCZ1dHQjdDQWdnUUFCZ1dHQW9ZSHNJQ0N4QUFHSUFFR0lZREdJb0Z3Z0lJRUFBWWdBUVlvZ1RDQWdVUUlSaXJBc0lDQlJBQUdPOEZ3Z0lJRUFBWUNCZ05HQjdDQWdnUUFCaWlCQmlKQmNJQ0J4QWhHS0FCR0FxWUF3Q1NCd0l4T2FBSDU3a0Imc2NsaWVudD1nd3Mtd2l6IikucGFyc2VVcmwoKTtpZighKGUgaW5zdGFuY2VvZiBnKSlyZXR1cm4gY29uc29sZS5sb2coZSksZX1PKCk7Cg==";
        let mut output = output_options("runtime_test", "local", "./tmp", false);
        let script = JSScript {
            name: String::from("protobuf_test"),
            script: test.to_string(),
        };
        execute_script(&mut output, &script).unwrap();
    }
}
