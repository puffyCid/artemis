use crate::artifacts::os::macos::bookmarks::parser::parse_bookmark;
use deno_core::{error::AnyError, op2, JsBuffer};

#[op2]
#[string]
/// Expose parsing bookmark data to `Deno`
pub(crate) fn get_bookmark(#[buffer] data: JsBuffer) -> Result<String, AnyError> {
    let book = parse_bookmark(&data)?;
    let results = serde_json::to_string(&book)?;
    Ok(results)
}

#[cfg(test)]
mod tests {
    use crate::{
        runtime::deno::execute_script, structs::artifacts::runtime::script::JSScript,
        structs::toml::Output,
    };

    fn output_options(name: &str, output: &str, directory: &str, compress: bool) -> Output {
        Output {
            name: name.to_string(),
            directory: directory.to_string(),
            format: String::from("json"),
            compress,
            url: Some(String::new()),
            api_key: Some(String::new()),
            endpoint_id: String::from("abcd"),
            collection_id: 0,
            output: output.to_string(),
            filter_name: Some(String::new()),
            filter_script: Some(String::new()),
            logging: Some(String::new()),
        }
    }

    #[test]
    fn test_get_bookmark() {
        let test = "Ly8gLi4vLi4vUHJvamVjdHMvYXJ0ZW1pcy1hcGkvc3JjL3V0aWxzL2Vycm9yLnRzCnZhciBFcnJvckJhc2UgPSBjbGFzcyBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihuYW1lLCBtZXNzYWdlKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgfQp9OwoKLy8gLi4vLi4vUHJvamVjdHMvYXJ0ZW1pcy1hcGkvc3JjL21hY29zL2Vycm9ycy50cwp2YXIgTWFjb3NFcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3JCYXNlIHsKfTsKCi8vIC4uLy4uL1Byb2plY3RzL2FydGVtaXMtYXBpL3NyYy9tYWNvcy9ib29rbWFyay50cwpmdW5jdGlvbiBwYXJzZUJvb2ttYXJrKGRhdGEpIHsKICB0cnkgewogICAgY29uc3QgcmVzdWx0cyA9IERlbm8uY29yZS5vcHMuZ2V0X2Jvb2ttYXJrKGRhdGEpOwogICAgY29uc3QgYm9vayA9IEpTT04ucGFyc2UocmVzdWx0cyk7CiAgICByZXR1cm4gYm9vazsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBuZXcgTWFjb3NFcnJvcigiQk9PS01BUksiLCBgZmFpbGVkIHRvIHBhcnNlIGJvb2ttYXJrOiAke2Vycn1gKTsKICB9Cn0KCi8vIG1haW4udHMKZnVuY3Rpb24gbWFpbigpIHsKICBjb25zdCBieXRlcyA9IFsKICAgIDk4LAogICAgMTExLAogICAgMTExLAogICAgMTA3LAogICAgMTkyLAogICAgMiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA0LAogICAgMTYsCiAgICA0OCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE2MiwKICAgIDEzNywKICAgIDE0NCwKICAgIDE4MywKICAgIDI1NCwKICAgIDkwLAogICAgNjIsCiAgICA5MiwKICAgIDIzNiwKICAgIDIwLAogICAgMTkzLAogICAgMjIsCiAgICAxNzgsCiAgICAxNjYsCiAgICA3NywKICAgIDU3LAogICAgMjI5LAogICAgMTUyLAogICAgMTUsCiAgICAyMTksCiAgICAyMDksCiAgICAxOTIsCiAgICA5OSwKICAgIDI0LAogICAgMTAwLAogICAgMTY3LAogICAgMTAxLAogICAgMTQ0LAogICAgMTA2LAogICAgMjUyLAogICAgMTQ4LAogICAgMzksCiAgICAxODgsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICA0LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMywKICAgIDMsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA4LAogICAgMCwKICAgIDQwLAogICAgNSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICA4NSwKICAgIDExNSwKICAgIDEwMSwKICAgIDExNCwKICAgIDExNSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDcsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAxLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgOTcsCiAgICAxMTAsCiAgICAxMDAsCiAgICAxMTQsCiAgICAxMTEsCiAgICAxMDUsCiAgICAxMDAsCiAgICAwLAogICAgOSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICA2OCwKICAgIDExMSwKICAgIDk5LAogICAgMTE3LAogICAgMTA5LAogICAgMTAxLAogICAgMTEwLAogICAgMTE2LAogICAgMTE1LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMTYsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAxLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgNzIsCiAgICAxMDEsCiAgICAxMDgsCiAgICAxMDgsCiAgICAxMTEsCiAgICAzMiwKICAgIDExOSwKICAgIDExMSwKICAgIDExNCwKICAgIDEwOCwKICAgIDEwMCwKICAgIDQ2LAogICAgMTAwLAogICAgMTExLAogICAgOTksCiAgICAxMjAsCiAgICAxNiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICA2LAogICAgMCwKICAgIDAsCiAgICAxNiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDMyLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNDgsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA2OCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDgsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA0LAogICAgMywKICAgIDAsCiAgICAwLAogICAgMTU3LAogICAgMTAyLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgOCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDQsCiAgICAzLAogICAgMCwKICAgIDAsCiAgICAxOTEsCiAgICAxMzIsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA4LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNCwKICAgIDMsCiAgICAwLAogICAgMCwKICAgIDI0MCwKICAgIDEzMiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDgsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA0LAogICAgMywKICAgIDAsCiAgICAwLAogICAgMTUsCiAgICAyMzIsCiAgICAxNDcsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE2LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDYsCiAgICAwLAogICAgMCwKICAgIDExNiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEzMiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE0OCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE2NCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDgsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNCwKICAgIDAsCiAgICAwLAogICAgNjUsCiAgICAxOTgsCiAgICAxMSwKICAgIDM5LAogICAgMTM2LAogICAgNzksCiAgICAxMSwKICAgIDE0MSwKICAgIDI0LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDIsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMTUsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA4LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNCwKICAgIDMsCiAgICAwLAogICAgMCwKICAgIDIsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDMsCiAgICAzLAogICAgMCwKICAgIDAsCiAgICAyNDUsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICA4LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDksCiAgICAwLAogICAgMCwKICAgIDEwMiwKICAgIDEwNSwKICAgIDEwOCwKICAgIDEwMSwKICAgIDU4LAogICAgNDcsCiAgICA0NywKICAgIDQ3LAogICAgMTIsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAxLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgNzcsCiAgICA5NywKICAgIDk5LAogICAgMTA1LAogICAgMTEwLAogICAgMTE2LAogICAgMTExLAogICAgMTE1LAogICAgMTA0LAogICAgMzIsCiAgICA3MiwKICAgIDY4LAogICAgOCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDQsCiAgICAzLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgODAsCiAgICAxNjEsCiAgICAyNywKICAgIDExNSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDgsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNCwKICAgIDAsCiAgICAwLAogICAgNjUsCiAgICAxOTcsCiAgICAxODIsCiAgICAxNzMsCiAgICAyMDksCiAgICAxMjgsCiAgICAwLAogICAgMCwKICAgIDM2LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDEsCiAgICAwLAogICAgMCwKICAgIDU3LAogICAgNjgsCiAgICA1NSwKICAgIDU1LAogICAgNTcsCiAgICA1NiwKICAgIDUyLAogICAgNjksCiAgICA0NSwKICAgIDY4LAogICAgNjksCiAgICA1NywKICAgIDU0LAogICAgNDUsCiAgICA1MiwKICAgIDU3LAogICAgNDgsCiAgICA3MCwKICAgIDQ1LAogICAgNTcsCiAgICA2NywKICAgIDUxLAogICAgNDksCiAgICA0NSwKICAgIDY1LAogICAgNTAsCiAgICA0OCwKICAgIDQ4LAogICAgNTYsCiAgICA2NiwKICAgIDY2LAogICAgNTIsCiAgICA0OCwKICAgIDY2LAogICAgNTYsCiAgICA2NSwKICAgIDI0LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDIsCiAgICAwLAogICAgMCwKICAgIDEyOSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAyMzksCiAgICAxOSwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICA0NywKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAxLAogICAgNSwKICAgIDAsCiAgICAwLAogICAgMjA0LAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMjU0LAogICAgMjU1LAogICAgMjU1LAogICAgMjU1LAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAxNiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDQsCiAgICAxNiwKICAgIDAsCiAgICAwLAogICAgOTIsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgNSwKICAgIDE2LAogICAgMCwKICAgIDAsCiAgICAxODAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMTYsCiAgICAxNiwKICAgIDAsCiAgICAwLAogICAgMjIwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDY0LAogICAgMTYsCiAgICAwLAogICAgMCwKICAgIDIwNCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAyLAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDE2OCwKICAgIDEsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA1LAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDI0LAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE2LAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDQwLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE3LAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDkyLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE4LAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDYwLAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE5LAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDc2LAogICAgMSwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDMyLAogICAgMzIsCiAgICAwLAogICAgMCwKICAgIDEzNiwKICAgIDEsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICA0OCwKICAgIDMyLAogICAgMCwKICAgIDAsCiAgICAxODAsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMSwKICAgIDE5MiwKICAgIDAsCiAgICAwLAogICAgMjUyLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDE3LAogICAgMTkyLAogICAgMCwKICAgIDAsCiAgICAzMiwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAxOCwKICAgIDE5MiwKICAgIDAsCiAgICAwLAogICAgMTIsCiAgICAxLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMTYsCiAgICAyMDgsCiAgICAwLAogICAgMCwKICAgIDQsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwCiAgXTsKICBjb25zdCByZXN1bHRzID0gcGFyc2VCb29rbWFyayhVaW50OEFycmF5LmZyb20oYnl0ZXMpKTsKICBpZiAocmVzdWx0cyBpbnN0YW5jZW9mIE1hY29zRXJyb3IpIHsKICAgIGNvbnNvbGUuZXJyb3IoYG5vIGJvb2ttYXJrP2ApOwogICAgcmV0dXJuOwogIH0KICBjb25zb2xlLmxvZyhyZXN1bHRzLnBhdGgpOwp9Cm1haW4oKTsK";
        let mut output = output_options("runtime_test", "local", "./tmp", true);

        let script = JSScript {
            name: String::from("bookmark_js"),
            script: test.to_string(),
        };
        execute_script(&mut output, &script).unwrap();
    }
}
