system = "macos"

[output]
name = "plist_data"
directory = "./tmp"
format = "json"
compress = false
timeline = false
endpoint_id = "6c51b123-1522-4572-9f2a-0bd5abd81b82"
collection_id = 1
output = "local"

[[artifacts]]
artifact_name = "script"
[artifacts.script]
name = "all_usr_plist_files"
# Parses all plist files in /usr/%
script = "Ly8gaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3B1ZmZ5Y2lkL2FydGVtaXMtYXBpL21hc3Rlci9zcmMvbWFjb3MvcGxpc3QudHMKZnVuY3Rpb24gZ2V0UGxpc3QocGF0aCkgewogIGNvbnN0IGRhdGEgPSBqc19nZXRfcGxpc3QocGF0aCk7CiAgcmV0dXJuIGRhdGE7Cn0KCi8vIGh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wdWZmeWNpZC9hcnRlbWlzLWFwaS9tYXN0ZXIvc3JjL3N5c3RlbS9vdXRwdXQudHMKZnVuY3Rpb24gb3V0cHV0UmVzdWx0cyhkYXRhLCBkYXRhX25hbWUsIG91dHB1dCkgewogIGNvbnN0IHN0YXR1cyA9IGpzX291dHB1dF9yZXN1bHRzKAogICAgZGF0YSwKICAgIGRhdGFfbmFtZSwKICAgIG91dHB1dCwKICApOwogIHJldHVybiBzdGF0dXM7Cn0KCi8vIGh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9wdWZmeWNpZC9hcnRlbWlzLWFwaS9tYXN0ZXIvc3JjL2ZpbGVzeXN0ZW0vZGlyZWN0b3J5LnRzCmFzeW5jIGZ1bmN0aW9uIHJlYWREaXIocGF0aCkgewogIGNvbnN0IGRhdGEgPSBhd2FpdCBqc19yZWFkX2RpcihwYXRoKTsKICByZXR1cm4gZGF0YTsKfQoKLy8gbWFpbi50cwphc3luYyBmdW5jdGlvbiBtYWluKCkgewogIGNvbnN0IHN0YXJ0X3BhdGggPSAiL3VzciI7CiAgY29uc3QgcGxpc3RfZmlsZXMgPSBbXTsKICBhd2FpdCByZWN1cnNlX2RpcihwbGlzdF9maWxlcywgc3RhcnRfcGF0aCk7CiAgcmV0dXJuIHBsaXN0X2ZpbGVzOwp9CmFzeW5jIGZ1bmN0aW9uIHJlY3Vyc2VfZGlyKHBsaXN0X2ZpbGVzLCBzdGFydF9wYXRoKSB7CiAgaWYgKHBsaXN0X2ZpbGVzLmxlbmd0aCA+IDIwKSB7CiAgICBjb25zdCBvdXQgPSB7CiAgICAgIG5hbWU6ICJhcnRlbWlzX3BsaXN0IiwKICAgICAgZGlyZWN0b3J5OiAiLi90bXAiLAogICAgICBmb3JtYXQ6ICJqc29uIiwgLyogSlNPTiAqLwogICAgICBjb21wcmVzczogZmFsc2UsCiAgICAgIGVuZHBvaW50X2lkOiAiYW55dGhpbmctaS13YW50IiwKICAgICAgY29sbGVjdGlvbl9pZDogMSwKICAgICAgb3V0cHV0OiAibG9jYWwiLCAvKiBMT0NBTCAqLwogICAgfTsKICAgIGNvbnN0IHN0YXR1cyA9IG91dHB1dFJlc3VsdHMoCiAgICAgIEpTT04uc3RyaW5naWZ5KHBsaXN0X2ZpbGVzKSwKICAgICAgImFydGVtaXNfaW5mbyIsCiAgICAgIG91dCwKICAgICk7CiAgICBpZiAoIXN0YXR1cykgewogICAgICBjb25zb2xlLmxvZygiQ291bGQgbm90IG91dHB1dCB0byBsb2NhbCBkaXJlY3RvcnkiKTsKICAgIH0KICAgIHBsaXN0X2ZpbGVzID0gW107CiAgfQogIGZvciAoY29uc3QgZW50cnkgb2YgYXdhaXQgcmVhZERpcihzdGFydF9wYXRoKSkgewogICAgY29uc3QgcGxpc3RfcGF0aCA9IGAke3N0YXJ0X3BhdGh9LyR7ZW50cnkuZmlsZW5hbWV9YDsKICAgIGlmIChlbnRyeS5pc19maWxlICYmIGVudHJ5LmZpbGVuYW1lLmVuZHNXaXRoKCJwbGlzdCIpKSB7CiAgICAgIGNvbnN0IGRhdGEgPSBnZXRQbGlzdChwbGlzdF9wYXRoKTsKICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBwbGlzdF9pbmZvID0gewogICAgICAgIHBsaXN0X2NvbnRlbnQ6IGRhdGEsCiAgICAgICAgZmlsZTogcGxpc3RfcGF0aCwKICAgICAgfTsKICAgICAgcGxpc3RfZmlsZXMucHVzaChwbGlzdF9pbmZvKTsKICAgICAgY29udGludWU7CiAgICB9CiAgICBpZiAoZW50cnkuaXNfZGlyZWN0b3J5KSB7CiAgICAgIGF3YWl0IHJlY3Vyc2VfZGlyKHBsaXN0X2ZpbGVzLCBwbGlzdF9wYXRoKTsKICAgIH0KICB9Cn0KbWFpbigpOwo="
