// ../../../Projects/artemis-api/src/utils/error.ts
var ErrorBase = class extends Error {
  constructor(name, message) {
    super();
    this.name = name;
    this.message = message;
  }
};

// ../../../Projects/artemis-api/src/filesystem/errors.ts
var FileError = class extends ErrorBase {
};

// ../../../Projects/artemis-api/src/filesystem/files.ts
function readTextFile(path) {
  try {
    const result = js_read_text_file(path);
    return result;
  } catch (err) {
    return new FileError(
      "READ_TEXT_FILE",
      `failed to read text file ${path}: ${err}`
    );
  }
}
function glob(pattern) {
  try {
    const result = js_glob(pattern);
    return result;
  } catch (err) {
    return new FileError("GLOB", `failed to glob pattern ${pattern}" ${err}`);
  }
}

// ../../../Projects/artemis-api/src/time/conversion.ts
function unixEpochToISO(timestamp) {
  if (timestamp === 0 || timestamp === 0n) {
    return new Date(Number(timestamp)).toISOString();
  }
  const milliseconds_len = 13;
  const milliseconds = 1e3;
  if (typeof timestamp === "number" && timestamp.toString().length < milliseconds_len) {
    const js_date = new Date(timestamp * milliseconds);
    return js_date.toISOString();
  }
  const microseconds_len = 16;
  if (timestamp.toString().length < microseconds_len) {
    return new Date(Number(timestamp)).toISOString();
  }
  const nanoseconds_len = 19;
  if (timestamp.toString().length < nanoseconds_len) {
    const milli_time2 = BigInt(timestamp) / BigInt(milliseconds);
    return new Date(Number(milli_time2)).toISOString();
  }
  if (timestamp.toString().length === nanoseconds_len) {
    const milli_time2 = BigInt(timestamp) / BigInt(milliseconds * milliseconds);
    return new Date(Number(milli_time2)).toISOString();
  }
  console.warn(
    `Received very large number:  ${timestamp}. Converting to max Number type value`
  );
  const milli_time = BigInt(timestamp) / BigInt(milliseconds);
  return new Date(Number(milli_time)).toISOString();
}

// ../../../Projects/artemis-api/src/macos/homebrew.ts
function getHomebrewInfo() {
  const packages = getPackages();
  const casks = getCasks();
  const info = {
    packages,
    casks
  };
  return info;
}
function getPackages(glob_path) {
  let paths = [
    "/opt/homebrew/Cellar/*/*/INSTALL_RECEIPT.json",
    "/usr/local/Cellar/*/*/INSTALL_RECEIPT.json"
  ];
  if (glob_path != void 0) {
    paths = [glob_path];
  }
  const brew_receipts = [];
  for (const path of paths) {
    const globs = glob(path);
    if (globs instanceof FileError) {
      console.warn(`failed to glob ${path}: ${globs}`);
      continue;
    }
    for (const entry of globs) {
      const brew_info = {
        installedAsDependency: false,
        installedOnRequest: false,
        installTime: "",
        sourceModified: "",
        version: "",
        name: "",
        description: "",
        homepage: "",
        url: "",
        license: "",
        caskName: "",
        formulaPath: ""
      };
      const dirs = entry.full_path.split("/");
      dirs.pop();
      dirs.push(".brew/*.rb");
      const rb_glob = dirs.join("/");
      const rb_path = glob(rb_glob);
      if (rb_path instanceof FileError) {
        continue;
      }
      for (const rb of rb_path) {
        if (!rb.is_file) {
          continue;
        }
        const formula = parseRuby(rb.full_path);
        if (formula instanceof FileError) {
          console.warn(
            `failed to parse ruby formula ${entry.full_path}: ${formula}`
          );
          continue;
        }
        brew_info.description = formula.description;
        brew_info.homepage = formula.homepage;
        brew_info.url = formula.url;
        brew_info.license = formula.license;
        brew_info.caskName = formula.caskName;
        brew_info.formulaPath = formula.formulaPath;
        brew_info.version = formula.version;
        brew_info.name = rb.filename.substring(0, rb.filename.length - 3);
        const receipt = readTextFile(entry.full_path);
        if (receipt instanceof FileError) {
          console.warn(
            `failed to read install_receipt.json format ${entry.full_path}: ${receipt}`
          );
          continue;
        }
        const receipt_data = JSON.parse(receipt);
        brew_info.installTime = unixEpochToISO(receipt_data["time"]);
        brew_info.installedAsDependency = receipt_data["installed_as_dependency"];
        brew_info.installedOnRequest = receipt_data["installed_on_request"];
        brew_info.sourceModified = unixEpochToISO(
          receipt_data["source_modified_time"]
        );
      }
      brew_receipts.push(brew_info);
    }
  }
  return brew_receipts;
}
function getCasks(glob_path) {
  let paths = [
    "/usr/local/Caskroom/*/.metadata/*/*/Casks/*.rb",
    "/opt/homebrew/Caskroom/*/.metadata/*/*/Casks/*.rb",
    "/usr/local/Caskroom/*/.metadata/*/*/Casks/*.json",
    "/opt/homebrew/Caskroom/*/.metadata/*/*/Casks/*.json"
  ];
  if (glob_path != void 0) {
    paths = [glob_path];
  }
  const casks = [];
  for (const path of paths) {
    const globs = glob(path);
    if (globs instanceof FileError) {
      console.warn(`failed to glob ${path}: ${globs}`);
      continue;
    }
    for (const entry of globs) {
      if (entry.filename.endsWith(".json")) {
        const text = readTextFile(entry.full_path);
        if (text instanceof FileError) {
          console.warn(
            `failed to read json ${entry.full_path}: ${text}`
          );
          continue;
        }
        const data = JSON.parse(text);
        const formula2 = {
          description: data["desc"],
          homepage: data["homepage"],
          url: data["url"],
          license: "",
          caskName: data["name"].join(" "),
          formulaPath: entry.full_path,
          version: data["version"]
        };
        casks.push(formula2);
      }
      if (!entry.filename.endsWith(".rb")) {
        continue;
      }
      const formula = parseRuby(entry.full_path);
      if (formula instanceof FileError) {
        console.warn(
          `failed to parse ruby formula ${entry.full_path}: ${formula}`
        );
        continue;
      }
      casks.push(formula);
    }
  }
  return casks;
}
function parseRuby(path) {
  const desc = /(?<=desc ).*$/m;
  const homepage_reg = /(?<=homepage ).*$/m;
  const reg_license = /(?<=license ).*$/m;
  const reg_url = /(?<=url ).*$/m;
  const reg_name = /(?<=name ).*$/m;
  const versionvalue = path.split("/");
  let version = "";
  if (path.includes("/Casks/")) {
    version = versionvalue[versionvalue.length - 4];
  } else {
    version = versionvalue[versionvalue.length - 3];
  }
  const rubyText = readTextFile(path);
  if (rubyText instanceof FileError) {
    return rubyText;
  }
  const description = rubyText.match(desc);
  const receipt = {
    description: "",
    homepage: "",
    url: "",
    license: "",
    caskName: "",
    formulaPath: path,
    version
  };
  if (typeof description?.[0] === "string") {
    receipt.description = description?.[0].replaceAll('"', "");
  }
  const homepage = rubyText.match(homepage_reg);
  if (typeof homepage?.[0] === "string") {
    receipt.homepage = homepage?.[0].replaceAll('"', "");
  }
  const license = rubyText.match(reg_license);
  if (typeof license?.[0] === "string") {
    receipt.license = license?.[0].replaceAll('"', "");
  }
  const url = rubyText.match(reg_url);
  if (typeof url?.[0] === "string") {
    receipt.url = url?.[0].replaceAll('"', "");
  }
  const name = rubyText.match(reg_name);
  if (typeof name?.[0] === "string" && path.includes("Cask")) {
    receipt.caskName = name?.[0].replaceAll('"', "");
  }
  return receipt;
}

// main.ts
function main() {
  const results = getHomebrewInfo();
  return results;
}
main();
