import { describe, expect, test } from '@jest/globals';
import { setupFastify } from '../app';
import { LocalSqlite } from '../database/db';

describe('enrollment module', () => {
    test('enroll an endpoint', async () => {
        const server = await setupFastify();
        const body = '{"enroll_key":"my key","endpoint_uuid":"a5be74de-f303-4303-a1ae-0b6229c01fdf","info":{"boot_time":"2025-06-13T23:09:53.000Z","hostname":"fedora","os_version":"42","uptime":74327,"kernel_version":"6.14.9-300.fc42.x86_64","platform":"Fedora Linux","cpu":[{"frequency":1763,"cpu_usage":0,"name":"cpu0","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1601,"cpu_usage":0,"name":"cpu1","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu2","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1960,"cpu_usage":0,"name":"cpu3","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu4","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1550,"cpu_usage":0,"name":"cpu5","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1100,"cpu_usage":0,"name":"cpu6","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu7","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1686,"cpu_usage":0,"name":"cpu8","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu9","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu10","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu11","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu12","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu13","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu14","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":2110,"cpu_usage":0,"name":"cpu15","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu16","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu17","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1000,"cpu_usage":0,"name":"cpu18","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu19","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu20","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu21","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16}],"disks":[{"disk_type":"SSD","file_system":"btrfs","mount_point":"/","total_space":2046687182848,"available_space":1534479130624,"removable":false},{"disk_type":"SSD","file_system":"btrfs","mount_point":"/home","total_space":2046687182848,"available_space":1534479130624,"removable":false},{"disk_type":"SSD","file_system":"ext4","mount_point":"/boot","total_space":1020702720,"available_space":450326528,"removable":false},{"disk_type":"SSD","file_system":"vfat","mount_point":"/boot/efi","total_space":627900416,"available_space":607662080,"removable":false}],"memory":{"available_memory":53838188544,"free_memory":45066108928,"free_swap":8589930496,"total_memory":67025211392,"total_swap":8589930496,"used_memory":13187022848,"used_swap":0},"performance":{"avg_one_min":1.26,"avg_five_min":0.91,"avg_fifteen_min":0.83},"interfaces":[],"version":"0.15.0","rust_version":"1.87.0","build_date":"2025-01-01"}}';
        const headers = { 'accept': 'application/json', 'content-type': 'application/json' };
        const response = await server.inject({ method: 'POST', 'url': '/v1/endpoint/enroll', body, headers });
        expect(String(JSON.parse(response.body)[ "endpoint_id" ]).length).toBe(36);
    });
    test('bad enroll key', async () => {
        const server = await setupFastify();
        const body = '{"enroll_key":"bad key","endpoint_uuid":"a5be74de-f303-4303-a1ae-0b6229c01fdf","info":{"boot_time":"2025-06-13T23:09:53.000Z","hostname":"fedora","os_version":"42","uptime":74327,"kernel_version":"6.14.9-300.fc42.x86_64","platform":"Fedora Linux","cpu":[{"frequency":1763,"cpu_usage":0,"name":"cpu0","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1601,"cpu_usage":0,"name":"cpu1","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu2","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1960,"cpu_usage":0,"name":"cpu3","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu4","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1550,"cpu_usage":0,"name":"cpu5","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1100,"cpu_usage":0,"name":"cpu6","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu7","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1686,"cpu_usage":0,"name":"cpu8","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu9","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu10","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu11","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu12","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu13","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu14","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":2110,"cpu_usage":0,"name":"cpu15","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu16","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu17","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1000,"cpu_usage":0,"name":"cpu18","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu19","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu20","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu21","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16}],"disks":[{"disk_type":"SSD","file_system":"btrfs","mount_point":"/","total_space":2046687182848,"available_space":1534479130624,"removable":false},{"disk_type":"SSD","file_system":"btrfs","mount_point":"/home","total_space":2046687182848,"available_space":1534479130624,"removable":false},{"disk_type":"SSD","file_system":"ext4","mount_point":"/boot","total_space":1020702720,"available_space":450326528,"removable":false},{"disk_type":"SSD","file_system":"vfat","mount_point":"/boot/efi","total_space":627900416,"available_space":607662080,"removable":false}],"memory":{"available_memory":53838188544,"free_memory":45066108928,"free_swap":8589930496,"total_memory":67025211392,"total_swap":8589930496,"used_memory":13187022848,"used_swap":0},"performance":{"avg_one_min":1.26,"avg_five_min":0.91,"avg_fifteen_min":0.83}}}';
        const headers = { 'accept': 'application/json', 'content-type': 'application/json' };
        const response = await server.inject({ method: 'POST', 'url': '/v1/endpoint/enroll', body, headers });
        expect(response.statusCode).toBe(400);

        expect(JSON.parse(response.body)[ "message" ]).toBe("Bad enrollment key");
    });
    test('list endpoints', async () => {
        const server = await setupFastify();
        const body = '{"enroll_key":"my key","endpoint_uuid":"a5be74de-f303-4303-a1ae-0b6229c01fdf","info":{"boot_time":"2025-06-13T23:09:53.000Z","hostname":"fedora","os_version":"42","uptime":74327,"kernel_version":"6.14.9-300.fc42.x86_64","platform":"Fedora Linux","cpu":[{"frequency":1763,"cpu_usage":0,"name":"cpu0","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1601,"cpu_usage":0,"name":"cpu1","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu2","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1960,"cpu_usage":0,"name":"cpu3","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu4","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1550,"cpu_usage":0,"name":"cpu5","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1100,"cpu_usage":0,"name":"cpu6","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu7","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1686,"cpu_usage":0,"name":"cpu8","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu9","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu10","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu11","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu12","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu13","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu14","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":2110,"cpu_usage":0,"name":"cpu15","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu16","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu17","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":1000,"cpu_usage":0,"name":"cpu18","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu19","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu20","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16},{"frequency":400,"cpu_usage":0,"name":"cpu21","vendor_id":"GenuineIntel","brand":"Intel(R) Core(TM) Ultra 9 185H","physical_core_count":16}],"disks":[{"disk_type":"SSD","file_system":"btrfs","mount_point":"/","total_space":2046687182848,"available_space":1534479130624,"removable":false},{"disk_type":"SSD","file_system":"btrfs","mount_point":"/home","total_space":2046687182848,"available_space":1534479130624,"removable":false},{"disk_type":"SSD","file_system":"ext4","mount_point":"/boot","total_space":1020702720,"available_space":450326528,"removable":false},{"disk_type":"SSD","file_system":"vfat","mount_point":"/boot/efi","total_space":627900416,"available_space":607662080,"removable":false}],"memory":{"available_memory":53838188544,"free_memory":45066108928,"free_swap":8589930496,"total_memory":67025211392,"total_swap":8589930496,"used_memory":13187022848,"used_swap":0},"performance":{"avg_one_min":1.26,"avg_five_min":0.91,"avg_fifteen_min":0.83},"interfaces":[],"version":"0.15.0","rust_version":"1.87.0","build_date":"2025-01-01"}}';
        const headers = { 'accept': 'application/json', 'content-type': 'application/json' };
        const response = await server.inject({ method: 'POST', 'url': '/v1/endpoint/enroll', body, headers });
        expect(response.statusCode).toBe(200);

        const db = new LocalSqlite("./build/test.db");
        const rows = db.listEndpoints();
        expect(rows.length).toBeGreaterThanOrEqual(1);

        expect(((rows.at(0) ?? { "endpoint_id": "test" })[ "endpoint_id" ] as string).length).toBe(36);
        const value = (rows.at(0) ?? { "info": "test" })[ "info" ] as string;
        expect(JSON.parse(String(value))[ "boot_time" ]).toBe("2025-06-13T23:09:53.000Z");

    });
});